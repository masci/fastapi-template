name: deploy
# on:
#   registry_package:
#     types: [published]
on:
  push:
    branches:
      - dev


env:
  GCP_ARTIFACT_REGISTRY: 'europe-west1-docker.pkg.dev'
  GCP_ARTIFACT_REGISTRY_REPONAME: 'docker-registry'
  GCP_MAIN_SERVICE_NAME:
  GCP_DEV_SERVICE_NAME:
  IMAGE_NAME: ${{ github.repository }}


jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: GCP login
      id: 'auth'
      uses: 'google-github-actions/auth@v0'
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'
        token_format: 'access_token'  # do auth + generate token to be used later
        access_token_lifetime: '300s'

    - name: Docker login
      uses: 'docker/login-action@v1'
      with:
        registry: ${{ env.GCP_ARTIFACT_REGISTRY }}
        username: 'oauth2accesstoken'
        password: '${{ steps.auth.outputs.access_token }}'

    - name: Pull image from GHR
      run: docker pull ghcr.io/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

    - name: Push the same image to Google Artifact Registry
      run: |
        docker tag ghcr.io/${{ env.IMAGE_NAME }}:${{ github.ref_name }} ${{ env.GCP_ARTIFACT_REGISTRY }}/${{ steps.auth.outputs.project_id }}/${{ env.GCP_ARTIFACT_REGISTRY_REPONAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
        docker push ${{ env.GCP_ARTIFACT_REGISTRY }}/${{ steps.auth.outputs.project_id }}/${{ env.GCP_ARTIFACT_REGISTRY_REPONAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

    # - name: Deploy Cloud Run Service
    #   uses: 'google-github-actions/deploy-cloudrun@v0'
    #   with:
    #     service: mutiny-backend-${{ github.ref_name }}
    #     image: europe-west1-docker.pkg.dev/${{ steps.auth.outputs.project_id }}/mutiny/bligh:${{ github.ref_name }}
    #     region: europe-west1